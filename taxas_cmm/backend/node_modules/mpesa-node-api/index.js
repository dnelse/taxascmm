require('dotenv').config();
const axios = require('axios').default;
const crypto = require('crypto');
const constants = require('constants');

const MP_BASE_URL = process.env.MPESA_API_HOST;
const MP_API_KEY = process.env.MPESA_API_KEY;
const MP_PUBLIC_KEY = process.env.MPESA_PUBLIC_KEY;

function _getBearerToken(mpesa_public_key, mpesa_api_key) {

  
    return  auth = new Buffer.from("85MRpefVx4EdgWshx8cTrBt16ssYRxTg:JE9GqoasQcKL9e2W").toString('base64');;
}

module.exports.initiate_c2b = async function (amount, msisdn, transaction_ref, thirdparty_ref) {
    try {
        let response;
        response = await axios({
            method: 'post',
            url: 'https://' + MP_BASE_URL + ':18352/ipg/v1x/c2bPayment/singleStage/',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + _getBearerToken('aaaab09uz9f3asdcjyk7els777ihmwv8', 'MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAszE+xAKVB9HRarr6/uHYYAX/RdD6KGVIGlHv98QKDIH26ldYJQ7zOuo9qEscO0M1psSPe/67AWYLEXh13fbtcSKGP6WFjT9OY6uV5ykw9508x1sW8UQ4ZhTRNrlNsKizE/glkBfcF2lwDXJGQennwgickWz7VN+AP/1c4DnMDfcl8iVIDlsbudFoXQh5aLCYl+XOMt/vls5a479PLMkPcZPOgMTCYTCE6ReX3KD2aGQ62uiu2T4mK+7Z6yvKvhPRF2fTKI+zOFWly//IYlyB+sde42cIU/588msUmgr3G9FYyN2vKPVy/MhIZpiFyVc3vuAAJ/mzue5p/G329wzgcz0ztyluMNAGUL9A4ZiFcKOebT6y6IgIMBeEkTwyhsxRHMFXlQRgTAufaO5hiR/usBMkoazJ6XrGJB8UadjH2m2+kdJIieI4FbjzCiDWKmuM58rllNWdBZK0XVHNsxmBy7yhYw3aAIhFS0fNEuSmKTfFpJFMBzIQYbdTgI28rZPAxVEDdRaypUqBMCq4OstCxgGvR3Dy1eJDjlkuiWK9Y9RGKF8HOI5a4ruHyLheddZxsUihziPF9jKTknsTZtF99eKTIjhV7qfTzxXq+8GGoCEABIyu26LZuL8X12bFqtwLAcjfjoB7HlRHtPszv6PJ0482ofWmeH0BE8om7VrSGxsCAwEAAQ=='),
                'Origin': process.env.MPESA_ORIGIN
            },
            data: {
                "input_TransactionReference": transaction_ref,
                "input_CustomerMSISDN": msisdn + "",
                "input_Amount": amount + "",
                "input_ThirdPartyReference": thirdparty_ref,
                "input_ServiceProviderCode": process.env.MPESA_SERVICE_PROVIDER_CODE
            }
        });
        return response.data;
    } catch (e) {
        if (e.response.data) {
            throw e.response.data;
        } else {
            throw e;
        }
    }
};

module.exports.initiate_b2c = async function (amount, msisdn, transaction_ref, thirdparty_ref) {
    try {
        let response;
        response = await axios({
            method: 'post',
            url: 'https://sandbox.safaricom.co.ke/mpesa/b2c/v1/paymentrequest',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + _getBearerToken('aaaab09uz9f3asdcjyk7els777ihmwv8', 'MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAszE+xAKVB9HRarr6/uHYYAX/RdD6KGVIGlHv98QKDIH26ldYJQ7zOuo9qEscO0M1psSPe/67AWYLEXh13fbtcSKGP6WFjT9OY6uV5ykw9508x1sW8UQ4ZhTRNrlNsKizE/glkBfcF2lwDXJGQennwgickWz7VN+AP/1c4DnMDfcl8iVIDlsbudFoXQh5aLCYl+XOMt/vls5a479PLMkPcZPOgMTCYTCE6ReX3KD2aGQ62uiu2T4mK+7Z6yvKvhPRF2fTKI+zOFWly//IYlyB+sde42cIU/588msUmgr3G9FYyN2vKPVy/MhIZpiFyVc3vuAAJ/mzue5p/G329wzgcz0ztyluMNAGUL9A4ZiFcKOebT6y6IgIMBeEkTwyhsxRHMFXlQRgTAufaO5hiR/usBMkoazJ6XrGJB8UadjH2m2+kdJIieI4FbjzCiDWKmuM58rllNWdBZK0XVHNsxmBy7yhYw3aAIhFS0fNEuSmKTfFpJFMBzIQYbdTgI28rZPAxVEDdRaypUqBMCq4OstCxgGvR3Dy1eJDjlkuiWK9Y9RGKF8HOI5a4ruHyLheddZxsUihziPF9jKTknsTZtF99eKTIjhV7qfTzxXq+8GGoCEABIyu26LZuL8X12bFqtwLAcjfjoB7HlRHtPszv6PJ0482ofWmeH0BE8om7VrSGxsCAwEAAQ=='),
                'Origin':'developer.mpesa.vm.co.mz'
            },
            data: {
                "input_TransactionReference": transaction_ref,
                "input_CustomerMSISDN": msisdn + "",
                "input_Amount": amount + "",
                "input_ThirdPartyReference": thirdparty_ref,
                "input_ServiceProviderCode": process.env.MPESA_SERVICE_PROVIDER_CODE
            }
        });
        console.log(response);
        return response;
    } catch (e) {
        console.log('erro'+e);
    }
};
